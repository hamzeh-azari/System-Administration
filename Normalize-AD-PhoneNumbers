
<#
.SYNOPSIS
    Cleans and standardizes both mobile and telephone numbers in Active Directory to the format (XXX) XXX-XXXX.

.DESCRIPTION
    This script retrieves all users from Active Directory, extracts digits from their 'mobile' and 'telephoneNumber' attributes,
    formats valid numbers to the North American standard, and updates the AD records accordingly.
    Only numbers with exactly 10 digits or 11 digits starting with '1' are processed. Others are skipped.

.NOTES
    Author: Hamzeh Azari Hashjin
    Date: 2025-07-08
    Requires: ActiveDirectory PowerShell module
#>

Import-Module ActiveDirectory

# Retrieve all users with both 'mobile' and 'telephoneNumber' attributes
$users = Get-ADUser -Filter * -Properties mobile, telephoneNumber

foreach ($user in $users) {

    # Define a helper function to clean and format a phone number
    function Format-PhoneNumber($rawNumber) {
        if (![string]::IsNullOrWhiteSpace($rawNumber)) {
            $digits = ($rawNumber -replace '[^0-9]', '')

            if ($digits.Length -eq 10 -or ($digits.Length -eq 11 -and $digits.StartsWith('1'))) {
                if ($digits.Length -eq 11) {
                    $digits = $digits.Substring(1)
                }
                return "({0}) {1}-{2}" -f $digits.Substring(0,3), $digits.Substring(3,3), $digits.Substring(6,4)
            }
        }
        return $null
    }

    # Process 'mobile' attribute
    $formattedMobile = Format-PhoneNumber $user.mobile
    if ($formattedMobile -and $formattedMobile -ne $user.mobile) {
        Set-ADUser -Identity $user.DistinguishedName -Replace @{mobile = $formattedMobile}
        Write-Host "Updated $($user.SamAccountName) [mobile]: $formattedMobile"
    }

    # Process 'telephoneNumber' attribute
    $formattedTelephone = Format-PhoneNumber $user.telephoneNumber
    if ($formattedTelephone -and $formattedTelephone -ne $user.telephoneNumber) {
        Set-ADUser -Identity $user.DistinguishedName -Replace @{telephoneNumber = $formattedTelephone}
        Write-Host "Updated $($user.SamAccountName) [telephoneNumber]: $formattedTelephone"
    }
}
